{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% load thumbnail %}

{% block title %}User{% endblock title %}
{% block css_include %}
<link rel="stylesheet" type="text/css" href="{% static 'css/community_user.css' %}">
{% endblock css_include %}

{% block content %}
<div class="user-content">
    <div class="left-column">
        <div class="user-info-box">
            <div class="profile-photo">

            </div>
            <div class="user-details">
                <h4>{{ user.get_full_name }}</h4>
                <p class="detail">Last login: {{ user.last_login|timesince }} ago</p>
                <p class="detail">Member since: {{ user.date_joined|date:"M Y" }}</p>
                <div class="follow-details">
                    <p class="detail" id="followers">{{ followers.count }} follower{{ followers|pluralize }}</p>
                    {% if user != request.user %}
                    <button type="button" class="btn btn-primary" hx-post="{% url 'follow_user' user.id %}"
                        hx-swap="none" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' 
                        hx-trigger="click" hx-on::after-request="handleFollowEvent(event)">{% follow_status request.user user %}</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="right-column">
        <div class="trees-box">
            <h4>Trees</h4>
            {% if trees %}
            {% for tree in trees %}
            <div class="tree-container">
                <span>{{ tree.name }}</span>
            </div>
            {% endfor %}
            {% else %}
            <p>This user has no public family trees yet.</p>
            {% endif %}
        </div>
        <div class="images-box">
            <h4>Images</h4>
            {% if images %}
            <div class="images-container">
                {% for image in images %}
                <div class="image-container">
                    <a href="#">
                        <img src="{% thumbnail image.image 150x0 crop='smart' %}">
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>This user has no public images yet.</p>
            {% endif %}

        </div>
    </div>
</div>
<script>
    function handleFollowEvent(event) {
        jsonData = JSON.parse(event.detail.xhr.response);
        if (jsonData.status == 'followed') {
            event.target.innerHTML = "Unfollow";
        } else if (jsonData.status == 'unfollowed') {
            event.target.innerHTML = "Follow";
        }
        let followerParagraph = document.getElementById("followers");
        let newText = jsonData.number_of_followers.toString() + " ";
        if(jsonData.number_of_followers == 1)
        {
            newText += "follower";
        } else {
            newText += "followers";
        }
        followerParagraph.textContent = newText;
    }
</script>
{% endblock content %}